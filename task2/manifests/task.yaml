# # --- 1. NAMESPACES ---
# apiVersion: v1
# kind: Namespace
# metadata:
#   name: frontend-ns
#   labels: { name: frontend-ns }
# ---
# apiVersion: v1
# kind: Namespace
# metadata:
#   name: backend-ns
#   labels: { name: backend-ns }
# ---
# apiVersion: v1
# kind: Namespace
# metadata:
#   name: db-storage-ns
#   labels: { name: db-storage-ns }

# # --- 2. CONFIGMAP & SECRET ---
# ---
# apiVersion: v1
# kind: ConfigMap
# metadata:
#   name: backend-config
#   namespace: backend-ns
# data:
#   DB_URL: "db-service.db-storage-ns.svc.cluster.local"
# ---
# apiVersion: v1
# kind: Secret
# metadata:
#   name: db-secret
#   namespace: db-storage-ns
# type: Opaque
# data:
#   password: cGFzc3dvcmQxMjM= # password123

# # --- 3. STORAGE (StorageClass & PVC) ---
# ---
# apiVersion: storage.k8s.io/v1
# kind: StorageClass
# metadata:
#   name: manual-sc
# provisioner: kubernetes.io/no-provisioner
# volumeBindingMode: WaitFirstConsumer
# ---
# apiVersion: v1
# kind: PersistentVolumeClaim
# metadata:
#   name: db-pvc
#   namespace: db-storage-ns
# spec:
#   accessModes: [ReadWriteOnce]
#   resources: { requests: { storage: 1Gi } }
#   storageClassName: manual-sc

# # --- 4. STATEFULSETS (REDIS & DATABASE) ---
# ---
# # Database Headless Service
# apiVersion: v1
# kind: Service
# metadata:
#   name: db-headless
#   namespace: db-storage-ns
# spec:
#   clusterIP: None
#   selector: { app: database }
#   ports: [{ port: 5432 }]
# ---
# # Database ClusterIP Service 
# apiVersion: v1
# kind: Service
# metadata:
#   name: db-service
#   namespace: db-storage-ns
# spec:
#   type: ClusterIP
#   selector: { app: database }
#   ports: [{ port: 5432 }]
# ---
# apiVersion: apps/v1
# kind: StatefulSet
# metadata:
#   name: db
#   namespace: db-storage-ns
# spec:
#   serviceName: "db-headless"
#   replicas: 1
#   selector: { matchLabels: { app: database } }
#   template:
#     metadata: { labels: { app: database } }
#     spec:
#       containers:
#       - name: postgres
#         image: postgres:alpine
#         volumeMounts:
#         - name: db-data
#           mountPath: /var/lib/postgresql/data
#         env:
#         - name: POSTGRES_PASSWORD
#           valueFrom: { secretKeyRef: { name: db-secret, key: password } }
#       volumes:
#       - name: db-data
#         persistentVolumeClaim:
#           claimName: db-pvc
# ---
# # Redis Headless & StatefulSet
# apiVersion: v1
# kind: Service
# metadata:
#   name: redis-headless
#   namespace: db-storage-ns
# spec:
#   clusterIP: None
#   selector: { app: redis }
#   ports: [{ port: 6379 }]
# ---
# apiVersion: apps/v1
# kind: StatefulSet
# metadata:
#   name: redis
#   namespace: db-storage-ns
# spec:
#   serviceName: "redis-headless"
#   replicas: 1
#   selector: { matchLabels: { app: redis } }
#   template:
#     metadata: { labels: { app: redis } }
#     spec:
#       containers:
#       - name: redis
#         image: redis:alpine

# # --- 5. APP DEPLOYMENTS (BACKEND & FRONTEND) ---
# ---
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: backend-deploy
#   namespace: backend-ns
# spec:
#   replicas: 1
#   selector: { matchLabels: { app: backend } }
#   template:
#     metadata: { labels: { app: backend } }
#     spec:
#       containers:
#       - name: backend
#         image: nabilaebrahim/my-backend:v1
#         envFrom: [{ configMapRef: { name: backend-config } }]
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   name: backend-service
#   namespace: backend-ns
# spec:
#   type: ClusterIP
#   ports: [{ port: 5000 }]
#   selector: { app: backend }
# ---
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: frontend-deploy
#   namespace: frontend-ns
# spec:
#   replicas: 1
#   selector: { matchLabels: { app: frontend } }
#   template:
#     metadata: { labels: { app: frontend } }
#     spec:
#       containers:
#       - name: frontend
#         image: nabilaebrahim/my-frontend:v1
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   name: frontend-service
#   namespace: frontend-ns
# spec:
#   type: ClusterIP
#   ports: [{ port: 80 }]
#   selector: { app: frontend }

# # --- 6. NETWORK POLICIES ---
# ---
# # Policy for Redis
# apiVersion: networking.k8s.io/v1
# kind: NetworkPolicy
# metadata:
#   name: redis-policy
#   namespace: db-storage-ns
# spec:
#   podSelector: { matchLabels: { app: redis } }
#   ingress:
#   - from: [{ namespaceSelector: { matchLabels: { name: backend-ns } } }]
# ---
# # Policy for Database
# apiVersion: networking.k8s.io/v1
# kind: NetworkPolicy
# metadata:
#   name: db-policy
#   namespace: db-storage-ns
# spec:
#   podSelector: { matchLabels: { app: database } }
#   ingress:
#   - from: [{ namespaceSelector: { matchLabels: { name: backend-ns } } }]

# # --- 7. INGRESS (TLS) ---
# ---
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: frontend-ingress
#   namespace: frontend-ns
#   annotations:
#     kubernetes.io/ingress.class: nginx
# spec:
#   tls:
#   - hosts: [nabila.local]
#     secretName: tls-secret
#   rules:
#   - host: nabila.local
#     http:
#       paths:
#       - path: /
#         pathType: Prefix
#         backend:
#           service: { name: frontend-service, port: { number: 80 } }
          
# # --- Policy for Backend (Allow only Frontend) ---
# apiVersion: networking.k8s.io/v1
# kind: NetworkPolicy
# metadata:
#   name: backend-policy
#   namespace: backend-ns 
# spec:
#   podSelector:
#     matchLabels:
#       app: backend 
#   policyTypes:
#   - Ingress
#   ingress:
#   - from:
#     - namespaceSelector:
#         matchLabels:
#           name: frontend-ns 
#     - podSelector:
#         matchLabels:
#           app: frontend 
#     ports:
#     - protocol: TCP
#       port: 5000          
          


########################################################################################################









# 1. NAMESPACES
apiVersion: v1
kind: Namespace
metadata:
  name: frontend-ns
  labels: { name: frontend-ns }
---
apiVersion: v1
kind: Namespace
metadata:
  name: backend-ns
  labels: { name: backend-ns }
---
apiVersion: v1
kind: Namespace
metadata:
  name: db-storage-ns
  labels: { name: db-storage-ns }

# 2. CONFIGMAP & SECRET
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-config
  namespace: backend-ns
data:
  DB_URL: "db-service.db-storage-ns.svc.cluster.local"
---
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
  namespace: db-storage-ns
type: Opaque
data:
  password: cGFzc3dvcmQxMjM= # password123

# 3. STORAGE
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: manual-sc
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitFirstConsumer
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: db-pvc
  namespace: db-storage-ns
spec:
  accessModes: [ReadWriteOnce]
  resources: { requests: { storage: 1Gi } }
  storageClassName: manual-sc

# 4. DATABASE & REDIS (StatefulSets)
---
apiVersion: v1
kind: Service
metadata:
  name: db-service
  namespace: db-storage-ns
spec:
  selector: { app: database }
  ports: [{ port: 5432 }]
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: db
  namespace: db-storage-ns
spec:
  serviceName: "db-service"
  replicas: 1
  selector: { matchLabels: { app: database } }
  template:
    metadata: { labels: { app: database } }
    spec:
      containers:
      - name: postgres
        image: postgres:alpine
        env:
        - name: POSTGRES_PASSWORD
          valueFrom: { secretKeyRef: { name: db-secret, key: password } }
        volumeMounts:
        - name: db-data
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: db-data
        persistentVolumeClaim: { claimName: db-pvc }
---
apiVersion: v1
kind: Service
metadata:
  name: redis-headless
  namespace: db-storage-ns
spec:
  clusterIP: None
  selector: { app: redis }
  ports: [{ port: 6379 }]
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
  namespace: db-storage-ns
spec:
  serviceName: "redis-headless"
  replicas: 1
  selector: { matchLabels: { app: redis } }
  template:
    metadata: { labels: { app: redis } }
    spec:
      containers:
      - name: redis
        image: redis:alpine

# 5. BACKEND (With Resources for HPA)
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-deploy
  namespace: backend-ns
spec:
  replicas: 1
  selector: { matchLabels: { app: backend } }
  template:
    metadata: { labels: { app: backend } }
    spec:
      containers:
      - name: backend
        image: nabilaebrahim/my-backend:v1
        resources:
          requests:
            cpu: "100m"
          limits:
            cpu: "200m"
        envFrom: [{ configMapRef: { name: backend-config } }]
---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: backend-ns
spec:
  selector: { app: backend }
  ports: [{ port: 5000 }]

# 6. HPA (Autoscaling)
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: backend-hpa
  namespace: backend-ns
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: backend-deploy
  minReplicas: 1
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50

# 7. FRONTEND
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-deploy
  namespace: frontend-ns
spec:
  replicas: 1
  selector: { matchLabels: { app: frontend } }
  template:
    metadata: { labels: { app: frontend } }
    spec:
      containers:
      - name: frontend
        image: nabilaebrahim/my-frontend:v1
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
  namespace: frontend-ns
spec:
  selector: { app: frontend }
  ports: [{ port: 80 }]

# 8. NETWORK POLICIES (Security)
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-policy
  namespace: backend-ns
spec:
  podSelector: { matchLabels: { app: backend } }
  ingress:
  - from:
    - namespaceSelector: { matchLabels: { name: frontend-ns } }
    ports: [{ port: 5000 }]
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: db-redis-policy
  namespace: db-storage-ns
spec:
  podSelector: {} # Protect everything in this namespace
  ingress:
  - from:
    - namespaceSelector: { matchLabels: { name: backend-ns } }
